blueprint:
  name: "üí¨ Entity State Notification"
  description: "

    ## üí• New In Version 3

    üîÉ support for multiple states or nummeric comarision (above/below)

    ü§Ø new logic for better troubleshooting and further development

    üì± multiple groups and devices for notifications possible

    üí• custom notification action

    ‚è∏Ô∏è stoppable and pausable periodic notifications


    ## ü§ô Features

    üéØ monitor entities for a specific state and trigger a notification

    üìù modify message, title, icon, color, channel, group etc

    üß∑ persistent notification until entity leaves specified state

    üîÑ periodic notification with stop functionality

    üé¨ custom actions

    ‚úÖ custom conditions


    ‚ÑπÔ∏è **Hints**

    If you want to test this automation, you need to change the state of an observed entity. You can do this in the developer options.
    Simply filter for your entity, select it and change the state to the trigger state manually.


    üìñ **Documentation:** [panhans.github.io/HomeAssistant/](https://panhans.github.io/HomeAssistant/)


    ‚õëÔ∏è **Help & FAQ**: [Entity State Notification](https://community.home-assistant.io/t/entity-state-notification)


    üíø **Version**: 3.2.1


    [![ko-fi](https://ko-fi.com/img/githubbutton_sm.svg)](https://ko-fi.com/Q5Q3QEH52)
    "
  source_url: https://github.com/panhans/HomeAssistant/blob/main/blueprints/automation/panhans/entity_state_notification.yaml
  domain: automation
  homeassistant:
    min_version: "2025.04.0"

  input:
    sensor_section:
      name: Entities / Equal Comparison
      icon: mdi:equal-box
      collapsed: true
      input:
        input_entities:
          name: "üñ≤Ô∏è Observed Entities"
          description: >
            `target`


            Entities which trigger the notification.
          default: []
          selector:
            entity:
              multiple: true

        input_entity_states:
          name: "üü¢ Entity States"
          description: >
            `target`


            Target state that triggers the automation.
          default: []
          selector:
            text:
              multiple: true

        input_entity_state_duration:
          name: "‚è≤Ô∏è State Duration"
          description: >
            `target`

            Duration the entity must be in target state.
          default:
            hours: 0
            minutes: 0
            seconds: 2
          selector:
            duration:

    numeric_entity_section:
      name: Numeric Above/Below Comparison
      icon: mdi:code-greater-than
      collapsed: true
      input:
        input_numeric_entities:
          name: "üñ≤Ô∏è Observed Numeric Entities"
          description: >
            `target`


            Entities which trigger the notification.
          default: []
          selector:
            entity:
              multiple: true

        input_numeric_entity_operator:
          name: "üîÉ Operator"
          description: >
            `target`


            Operator to compare the state of the entity.
          default: "above"
          selector:
            select:
              options:
                - label: "‚ñ∂Ô∏è above"
                  value: "above"
                - label: "‚óÄÔ∏è below"
                  value: "below"

        input_numeric_entity_state:
          name: "üü¢ Entity State"
          description: >
            `target`


            Target state that triggers the automation.
          default: 0
          selector:
            number:
              max: 9999999999
              min: -9999999999

        input_numeric_entity_state_duration:
          name: "‚è≤Ô∏è State Duration"
          description: >
            `target`


            Duration the entity must be in target state.
          default:
            hours: 0
            minutes: 0
            seconds: 2
          selector:
            duration:

    notifcation_section:
      name: Notification Settings
      icon: mdi:chat
      collapsed: true
      input:
        input_notify_devices:
          name: "üì± Device to notify"
          description: >
            `notification`


            Devices that receive the notification.
          default: []
          selector:
            device:
              multiple: true
              filter:
                integration: mobile_app

        input_notify_groups:
          name: "ü´Ç Notification Group"
          description: >
            `notification`


            Name of the notification groups.
          default: []
          selector:
            text:
              multiple: true

        input_title:
          name: "üìï Notification Title"
          description: >
            `notification`


            Title of the notification.
          default: "{{ entity_name }} is {{ new_state }}"

        input_message:
          name: "üí¨ Notification Message"
          description: >
            `notification`


            Message of the notification.
          default: "Keep in mind: {{ entity_name }} is {{ new_state }}"

        input_persistent_notification:
          name: "ü™® Persistent Notification"
          description: >
            `notification`

            If turned on you can't swipe away the notification. It only disappears if the observed entity leave the target state combined with the operator.
          default: false
          selector:
            boolean:

        input_notification_auto_delete:
          name: "‚ùå Auto Close Notifications"
          description: >
            `notification`


            If enabled the notifications will be deleted automatically after the entity leaves the target state condition.
          default: true
          selector:
            boolean:

        input_ha_notification:
          name: "üè† Persistent HomeAssistant Notification"
          description: >
            `notification`


            Creates a notification in your home assistant frontend.
          default: false
          selector:
            boolean:

    mobile_appearance_section:
      name: Mobile Notification Appearance
      icon: mdi:palette
      collapsed: true
      input:
        input_status_bar_icon:
          name: "üå† Status Bar Icon"
          description: >
            `Android` `optional`


            Sets the status bar icon.
          default: mdi:home-assistant
          selector:
            icon:
              placeholder: mdi:home-assistant

        input_notification_color:
          name: "üé® Notification Color"
          description: >
            `Android` `optional`


            Color of the notification.
          default: [100, 200, 240]
          selector:
            color_rgb:

        input_channel:
          name: "üì≠ Notification Channel"
          description: >
            `Android` `optional`


            You can set a notification channel. In your companion app you can set e.g. a custom sound for notifications in this channel.
          default: "General"

        input_group:
          name: "üìë Notification Group"
          description: >
            `Android` `optional`


            Group notifications by using this identifier.
          default: "espn-notification-group"

        input_vibration_pattern:
          name: "üì≥ Vibration Pattern"
          description: >
            `Android` `optional`


            Pattern of the vibration when notification arrives."
          default: "100, 100"

        input_led_color:
          name: "üí° Notification LED Color"
          description: >
            `Android` `optional`


            Color of the phone LED after incoming notification."
          default: [100, 200, 240]
          selector:
            color_rgb:

    peridodic_notification_section:
      name: Periodic Notification Settings
      icon: mdi:refresh
      collapsed: true
      input:
        input_period:
          name: "üîÑ Periodic Notification"
          description: >
            `periodic` `notification`


            Sends notification periodically. 0 means off.
          default:
            hours: 0
            minutes: 0
            seconds: 0
          selector:
            duration:

        input_stop_button_text:
          name: "üí¨ Stop Button Text"
          description: >
            `periodic` `optional`


            Text for stop button in the notification to interrupt the periodic send notifications.
          default: "Stop notifying"

        input_pause_duration:
          name: "‚è∏Ô∏è Pause Duration"
          description: >
            `periodic` `notification`


            If you define a duration greater than 0 a pause button will be shown in your periodic notifications.
          default:
            hours: 0
            minutes: 0
            seconds: 0
          selector:
            duration:

        input_pause_button_text:
          name: "üí¨ Pause Button Text"
          description: >
            `periodic` `optional`


            Text for pause button in the notifications.
          default: "Pause"

    custom_notification_action:
      name: Notification Action
      icon: mdi:movie-open
      collapsed: true
      input:
        input_custom_notification_action_button_text:
          name: "üí¨ Notification Action Button Text"
          description: >
            `custom action` `optional`


            Text for the action button in the notification.
          default: "My Custom Action"

        input_custom_notification_action:
          name: "üé¨ Notification Action"
          description: >
            `optional`


            Notification action that gets executed when you press the notification action button.
          default: []
          selector:
            action: {}

    custom_section:
      name: Custom Actions / Conditions
      icon: mdi:cog
      collapsed: true
      input:
        input_custom_condition:
          name: "‚ùå Conditions"
          description: >
            `optional`


            Condition that must be met for the notification to be triggered.
          default: []
          selector:
            condition:

        input_custom_action_on:
          name: "üé¨ Custom Action On"
          description: >
            `optional`


            Custom action when your observed entity enters the target states.
          default: []
          selector:
            action: {}

        input_custom_action_off:
          name: "üé¨ Custom Action Off"
          description: >
            `optional`


            Custom action when observed entity leave the target state. Keep in mind this action also will be fired if your custom condition doesn't match.
          default: []
          selector:
            action: {}

trigger_variables:
  input_entities: !input input_entities

trigger:
  - id: "state_on"
    trigger: state
    entity_id: !input input_entities
    to: !input input_entity_states
    for: !input input_entity_state_duration

  - id: "state_off"
    trigger: state
    entity_id: !input input_entities
    not_to: !input input_entity_states

  - id: "above"
    trigger: numeric_state
    entity_id: !input input_numeric_entities
    above: !input input_numeric_entity_state
    for: !input input_numeric_entity_state_duration

  - id: "below"
    trigger: numeric_state
    entity_id: !input input_numeric_entities
    below: !input input_numeric_entity_state
    for: !input input_numeric_entity_state_duration

  - id: "above_off"
    trigger: numeric_state
    entity_id: !input input_numeric_entities
    above: !input input_numeric_entity_state

  - id: "below_off"
    trigger: numeric_state
    entity_id: !input input_numeric_entities
    below: !input input_numeric_entity_state

  - id: "period"
    trigger: event
    event_type: esn_event
    event_data:
      automation: "{{ this.entity_id }}"

  - trigger: event
    id: "custom_notification_action"
    event_type: mobile_app_notification_action
    event_data:
      action: "{{ md5('CA_' + this.entity_id) }}"

variables:
  # variables
  input_numeric_entity_operator: !input input_numeric_entity_operator
  input_numeric_entity_state: !input input_numeric_entity_state
  input_period: !input input_period
  input_notify_devices: !input input_notify_devices
  input_notify_groups: !input input_notify_groups
  input_notification_color: !input input_notification_color
  input_led_color: !input input_led_color
  input_stop_button_text: !input input_stop_button_text
  input_entity_states: !input input_entity_states
  input_notification_auto_delete: !input input_notification_auto_delete
  input_custom_notification_action_button_text: !input input_custom_notification_action_button_text
  input_custom_notification_action: !input input_custom_notification_action
  input_pause_duration: !input input_pause_duration
  input_pause_button_text: !input input_pause_button_text

  # helper
  is_period_trigger: "{{ trigger.id == 'period' }}"
  is_custom_notification_action_trigger: "{{ trigger.id == 'custom_notification_action' }}"
  now_ts: "{{ now() }}"
  is_perodical: "{{ as_datetime(now_ts) != as_datetime(now_ts) + timedelta(**input_period) }}"
  is_pausable: "{{ (as_datetime(now_ts) != as_datetime(now_ts) + timedelta(**input_pause_duration)) and is_perodical }}"
  entity: >
    {% if is_period_trigger %}
      {{ trigger.event.data.entity }}
    {% elif is_custom_notification_action_trigger %}
      {{ "" }}
    {% else %}
      {{ trigger.entity_id }}
    {% endif %}
  has_custom_notification_action: "{{ input_custom_notification_action != [] }}"
  entity_name: >
    {% if entity == "" %}
      {{ "" }}
    {% else %}
      {{ state_attr(entity, 'friendly_name') }}
    {% endif %}

  action_tag: "{{ md5('STOP_' + this.entity_id + '_' + entity) }}"
  action_tag_pause: "{{ md5('PAUSE_' + this.entity_id + '_' + entity) }}"
  custom_action_tag: "{{ md5('CA_' + this.entity_id) }}"
  tag: >
    {% if is_custom_notification_action_trigger %}
      {{ "" }}
    {% else %}
      {{ this.entity_id.split('.')[1] + entity.split('.')[1] }}
    {% endif %}
  notification_color_hex: "#{{ '%02x%02x%02x' | format(input_notification_color[0], input_notification_color[1], input_notification_color[2]) }}"
  led_color_hex: "#{{ '%02x%02x%02x' | format(input_led_color[0], input_led_color[1], input_led_color[2]) }}"
  action: >
    {% set result = [] %}
    {% if has_custom_notification_action %}
      {% set result = result + [{'action': custom_action_tag, 'title': input_custom_notification_action_button_text}] %}
    {% endif %}
    {% if is_perodical %}
      {% set result = result + [{'action': action_tag, 'title': input_stop_button_text}] %}
    {% endif %}
    {% if is_pausable %}
      {% set result = result + [{'action': action_tag_pause, 'title': input_pause_button_text}] %}
    {% endif %}
    {{ result }}

  # state evaluation
  new_state: >
    {% if is_period_trigger %}
      {{ states(entity) }}
    {% elif is_custom_notification_action_trigger %}
      {{ none }}
    {% else %}
      {{ trigger.to_state.state }}
    {% endif %}

  old_state: >
    {% if is_period_trigger %}
      {{ trigger.event.data.last_state }}
    {% elif is_custom_notification_action_trigger %}
      {{ none }}
    {% else %}
      {{ trigger.from_state.state }}
    {% endif %}

  # devices
  notify_devices: "{{ input_notify_devices | map('device_attr', 'name') | list }}"

  notify: >
    {% set result = namespace(r=[]) %}
    {% for device in notify_devices %}
      {% set result.r = result.r + ['notify.mobile_app_' + device | slugify] %}
    {% endfor %}
    {% for group in input_notify_groups %}
      {% set result.r = result.r + ['notify.' + group] %}
    {% endfor %}

    {{ result.r }}

  # trigger evaluation
  create_notifictaion: >
    {{ 
      trigger.id in ['state_on','period'] or 
      (trigger.id in ['above'] and input_numeric_entity_operator == 'above') or
      (trigger.id in ['below'] and input_numeric_entity_operator == 'below')
    }}

  custom_notification_action_trigger: "{{ trigger.id in ['custom_notification_action'] }}"

condition:
  - condition: or
    conditions:
      - condition: template
        value_template: "{{ custom_notification_action_trigger }}"
      - condition: template
        value_template: "{{ not create_notifictaion and input_notification_auto_delete }}"
      - condition: and
        conditions:
          - condition: and
            conditions: !input input_custom_condition
          - condition: template
            value_template: "{{ create_notifictaion }}"

action:
  - choose:
      - conditions:
          - condition: template
            value_template: "{{ custom_notification_action_trigger }}"
        sequence:
          - choose: []
            default: !input input_custom_notification_action
    default:
      - if:
          - condition: template
            value_template: "{{ create_notifictaion }}"
        then:
          # Notify
          - if:
              - condition: template
                value_template: !input input_ha_notification
            then:
              - action: persistent_notification.create
                data:
                  title: !input input_title
                  message: !input input_message
                  notification_id: "{{ tag }}"

          - variables:
              custom_action_on: !input input_custom_action_on
          - if:
              - condition: template
                value_template: "{{ custom_action_on != none }}"
            then:
              - choose: []
                default: !input input_custom_action_on

          - repeat:
              count: "{{ notify | count | int }}"
              sequence:
                - variables:
                    index: "{{ repeat.index-1 }}"
                    notify_device: "{{ notify[index] }}"
                - action: "{{ notify_device }}"
                  data:
                    title: !input input_title
                    message: !input input_message
                    data:
                      ttl: 0
                      priority: high
                      notification_icon: !input "input_status_bar_icon"
                      tag: "{{ tag }}"
                      persistent: !input input_persistent_notification
                      sticky: !input input_persistent_notification
                      channel: !input input_channel
                      group: !input input_group
                      color: "{{ notification_color_hex }}"
                      vibrationPattern: !input input_vibration_pattern
                      ledColor: "{{ led_color_hex }}"
                      actions: "{{ action }}"

          - if:
              - condition: template
                value_template: "{{ is_perodical }}"
            then:
              # period logic
              - wait_for_trigger:
                  - trigger: event
                    event_type: mobile_app_notification_action
                    event_data:
                      action: "{{ action_tag }}"
                  - trigger: event
                    event_type: mobile_app_notification_action
                    event_data:
                      action: "{{ action_tag_pause }}"
                timeout: !input input_period
              - variables:
                  is_paused: "{{ wait.trigger != none and wait.trigger.event.data.action == action_tag_pause }}"
              - if:
                  - condition: template
                    value_template: "{{ is_paused }}"
                then:
                  - delay: !input input_pause_duration
              - variables:
                  latest_state: "{{ states(entity) }}"
                  latest_trigger_id: >
                    {% if is_period_trigger %}
                      {{ trigger.event.data.trigger_id }}
                    {% else %}
                      {{ trigger.id }}
                    {% endif %}
                  latest_state_condition: >
                    {% if latest_trigger_id == 'state_on' %}
                      {{ latest_state in input_entity_states }}
                    {% elif latest_trigger_id == 'above' %}
                      {{ latest_state | float > input_numeric_entity_state | float }}
                    {% elif latest_trigger_id == 'below' %}
                      {{ latest_state | float < input_numeric_entity_state | float }}
                    {% endif %}
              - if:
                  - condition: or
                    conditions:
                      - condition: template
                        value_template: "{{ latest_state_condition and wait.trigger == none }}"
                      - condition: template
                        value_template: "{{ latest_state_condition and is_paused }}"
                then:
                  - event: esn_event
                    event_data:
                      entity: "{{ entity }}"
                      automation: "{{ this.entity_id }}"
                      last_state: "{{ latest_state }}"
                      trigger_id: "{{ latest_trigger_id }}"
        else:
          # Delete Notifications
          - action: notify.notify
            data:
              data:
                tag: "{{ tag }}"
                ttl: 0
                priority: high
              message: clear_notification
          - action: persistent_notification.dismiss
            data:
              notification_id: "{{ tag }}"
          - variables:
              custom_action_off: !input input_custom_action_off
          - if:
              - condition: template
                value_template: "{{ custom_action_off != none }}"
            then:
              - choose: []
                default: !input input_custom_action_off

mode: parallel
